{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  
  {% if user.is_authenticated %}
    <form action="{% url 'users:logout' %}" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary">Log Out</button>
    </form>
  {% else %}
    <a href="{% url 'users:login' %}" class="btn btn-primary">Log In</a>
  {% endif %}
    
  <h1 class="text-center">To do list app</h1>
  <!-- List of tasks -->
  <div id="taskList" class="list-group">
    {% for task in tasks %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div class="col-5">
        <h5 class="mb-1 flex-grow-1">{{ task.title }}</h5>
      </div>
      <div class="col-5">      
        <p class="mb-1 flex-grow-1">{{ task.description }}</p>
      </div>
      <button 
        class="btn btn-danger btn-sm flex-grow-0 btn-delete-task"
        data-task-id="{{ task.pk }}">
        Delete
      </button>
    </div>
    {% endfor %}
  </div>

  <!-- Form for making a new task  -->
  <form id="taskForm" class="form-inline d-flex align-items-center justify-content- mt-4" method="POST">
    {% csrf_token %}
    <div class="form-group flex-grow-1 mb-2 mr-sm-2">
      <input type="text" class="form-control" id="taskTitle" name="task_title" placeholder="Enter task title">
    </div>
    <div class="form-group flex-grow-1 mb-2 mr-sm-2">
      <input type="text" class="form-control" id="taskDescription" name="task_description" placeholder="Enter task description">
    </div>
    <button type="submit" class="btn btn-primary mb-2 flex-grow-0">Add Task</button>
  </form>
</div>

<script>
  // Delete button handling
  const deleteBtns = document.querySelectorAll(".btn-delete-task");
  deleteBtns.forEach(btn => btn.addEventListener("click", deleteTask));

  function deleteTask(event) {
    event.preventDefault();

    const btn = event.target;
    fetch('', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({'task_id': btn.dataset.taskId}),
    })
    .then(response => response.json())
    .then(data => {
      if (data['success']) {
        btn.parentElement.remove();
      } else {
        alert("Deletion mistake: " + data['error'])
      }
    })
  }

  // Form handling
  const form = document.getElementById('taskForm');
  form.addEventListener("submit", createTask);

  function createTask(event) {
    event.preventDefault();
    
    const taskTitle = document.getElementById('taskTitle').value;
    const taskDescription = document.getElementById('taskDescription').value;

    fetch(form.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({'task_title': taskTitle, 'task_description': taskDescription})
    })
    .then(response => response.json())
    .then(data => {
      if (data['success']) {
        const newTask = document.createElement('div');
        newTask.classList.add(
          "list-group-item",
          "d-flex",
          "justify-content-between",
          "align-items-center"
        );
        newTask.innerHTML = `
        <div class="col-5">
            <h5 class="mb-1 flex-grow-1">${taskTitle}</h5>
          </div>
          <div class="col-5">
            <p class="mb-1 flex-grow-1">${taskDescription}</p>
          </div>
          <button class="btn btn-danger btn-sm flex-grow-0 btn-delete-task">Delete</button>
        `;
        newTask.querySelector(".btn-delete-task").addEventListener('click', deleteTask);

        document.getElementById('taskList').appendChild(newTask);

        form.reset();
      } else {
        alert("Creation mistake: " + data['error'])
      }
    })
  }
</script>

{% endblock %}